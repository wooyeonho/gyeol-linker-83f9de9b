# GYEOL (결) - AI Digital Companion
# "대화할수록 성장하고 진화하는 나만의 AI"

## 프로젝트 정의

```
서비스명: GYEOL (결)
핵심 개념: AI 디지털 동반자
핵심 기능: 대화 → 성격 진화 → 비주얼 변화
기술: Next.js 15 + Supabase + React Three Fiber + BYOK
```

## 아키텍처

```
사용자 → Next.js App (/) → API Routes (/api/*)
                                ↓
                    OpenClaw Gateway (선택)
                    BYOK (사용자 API 키)
                    Groq (서버 폴백)
                                ↓
                    Supabase (PostgreSQL)
                    - gyeol_agents
                    - gyeol_conversations
                    - gyeol_messages
                    - gyeol_autonomous_logs
                    - gyeol_user_api_keys
```

## 디렉터리 구조

```
app/                    → 페이지 & API 라우트
  page.tsx              → 메인 (Void + 채팅 + 진화)
  settings/             → 설정 (BYOK, AI Brain, Safety)
  activity/             → 활동 피드
  social/               → AI 매칭/소셜
  market/skins/         → 스킨 마켓
  market/skills/        → 스킬 마켓
  api/chat/             → 채팅 (멀티 프로바이더)
  api/agent/            → 에이전트 CRUD
  api/byok/             → BYOK 키 관리
  api/conversations/    → 대화 기록
  api/activity/         → 활동 로그
  api/social/matches/   → AI 매칭
  api/market/           → 스킨/스킬
  api/admin/            → Kill Switch, 상태
components/             → ChatInterface, VoidCanvas, EvolutionCeremony, VoiceInput
lib/gyeol/              → 타입, 상수, BYOK, 진화엔진, 보안, 소셜
store/                  → Zustand (gyeol-store)
supabase/migrations/    → DB 스키마
docs/gyeol/             → 설계 문서
```

## 코딩 규칙

1. TypeScript strict mode
2. Next.js 15 App Router 패턴 준수
3. Supabase RLS 보안 정책 준수
4. 에러 처리 필수 (try/catch, 사용자 피드백)
5. BYOK 키는 반드시 서버에서만 복호화
6. 클라이언트에 API 키 노출 금지
7. Tailwind CSS 사용, 다크 테마 기본
8. 모바일 퍼스트 반응형

## AI 채팅 호출 순서

```
1. OpenClaw Gateway (OPENCLAW_GATEWAY_URL 설정 시)
2. BYOK (사용자 등록 키: preferred_provider → groq → openai → deepseek → anthropic)
3. 서버 Groq (GROQ_API_KEY 환경변수)
4. 기본 안내 메시지
```

## 핵심 타입

```typescript
interface Agent {
  id: string;
  user_id: string;
  name: string;
  generation: number;        // Gen 1~5
  personality: Personality;
  visual_state: VisualState;
  conversation_count: number;
  total_messages: number;
}

interface Personality {
  warmth: number;    // 0~100
  logic: number;
  creativity: number;
  humor: number;
  empathy: number;
}

interface VisualState {
  baseColor: string;
  glowIntensity: number;
  particleCount: number;
  pulseSpeed: number;
}
```

## 진화 시스템

- 대화 분석 → 성격 델타 계산 → personality 업데이트
- 10회 대화마다 진화 체크
- Gen 기준: conversation_count 10/30/70/150/300
- Gen 레벨업 시 EvolutionCeremony 연출

## 보안 레이어

- content-filter: 입/출력 욕설, PII 감지
- kill-switch-check: 관리자 긴급 정지 (30초 캐시)
- audit-logger: 모든 활동 기록
- BYOK: AES-256-GCM 암호화, 서버 전용 복호화

## 환경 변수

```
NEXT_PUBLIC_SUPABASE_URL      # Supabase URL (필수)
NEXT_PUBLIC_SUPABASE_ANON_KEY # Supabase Anon Key (필수)
SUPABASE_SERVICE_KEY          # Service Role Key (필수)
ENCRYPTION_SECRET             # BYOK 암호화 키 (필수)
GROQ_API_KEY                  # Groq 폴백 (선택)
OPENCLAW_GATEWAY_URL          # OpenClaw (선택)
KILL_SWITCH_TOKEN             # 관리자 토큰 (선택)
NEXT_PUBLIC_SITE_URL          # 사이트 URL (선택)
```

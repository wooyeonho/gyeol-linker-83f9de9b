-- ============================================
-- RLS 보안 정책 강화
-- 시스템 안정화 및 보안 강화
-- ============================================

-- ============================================
-- 1. profiles 테이블 보안 강화
-- ============================================

-- 기존 정책 확인 및 강화
-- balance 필드는 본인만 수정 가능 (이미 구현됨, 확인)

-- 추가 보안: 타인의 balance 조회 불가 확인
-- 기존 정책 "사용자는 본인 프로필 조회 가능"이 이미 이를 보장함

-- balance 수정 시 추가 검증 (트리거로 구현 가능하지만, RLS로도 충분)
-- 현재 RLS 정책 "사용자는 본인 프로필 수정 가능"이 이미 이를 보장함

-- ============================================
-- 2. payouts 테이블 보안 강화
-- ============================================

-- 관리자는 출금 상태 수정 가능 (UPDATE 정책 추가)
CREATE POLICY "관리자는 출금 상태 수정 가능"
ON payouts FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = auth.uid() 
    AND role = 'admin'
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = auth.uid() 
    AND role = 'admin'
  )
);

-- 판매자는 본인 출금 내역만 수정 불가 (이미 SELECT만 가능하므로 안전)
-- 추가 보안: 판매자는 출금 상태를 수정할 수 없도록 명시적으로 차단
-- (기본적으로 UPDATE 정책이 없으므로 이미 차단됨)

-- ============================================
-- 3. orders 테이블 보안 강화
-- ============================================

-- 기존 정책 점검:
-- - 구매자는 본인 주문만 조회 가능 ✓
-- - 판매자는 본인 프롬프트 주문만 조회 가능 ✓
-- - 관리자는 모든 주문 조회 가능 ✓

-- 추가 보안: 주문 상태 수정은 구매자/판매자 불가 (시스템에서만 처리)
-- 주문 생성 후 상태 변경은 외부 결제 시스템과 연동되므로
-- 일반 사용자는 주문 상태를 수정할 수 없도록 함 (기본적으로 UPDATE 정책 없음)

-- 관리자는 주문 상태 수정 가능 (필요한 경우)
CREATE POLICY "관리자는 주문 상태 수정 가능"
ON orders FOR UPDATE
USING (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = auth.uid() 
    AND role = 'admin'
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM profiles 
    WHERE id = auth.uid() 
    AND role = 'admin'
  )
);

-- ============================================
-- 4. 보안 감사 요약
-- ============================================

-- profiles 테이블:
-- ✓ balance는 본인만 수정 가능 (RLS 정책으로 보장)
-- ✓ 타인의 balance 조회 불가 (RLS 정책으로 보장)
-- ✓ 본인 정보만 조회/수정 가능

-- payouts 테이블:
-- ✓ 판매자는 본인 출금 내역만 조회 가능
-- ✓ 판매자는 출금 신청만 가능 (수정 불가)
-- ✓ 관리자는 모든 출금 내역 조회 가능
-- ✓ 관리자는 출금 상태 수정 가능 (새로 추가)

-- orders 테이블:
-- ✓ 구매자는 본인 주문만 조회 가능
-- ✓ 판매자는 본인 프롬프트 주문만 조회 가능
-- ✓ 관리자는 모든 주문 조회 가능
-- ✓ 관리자는 주문 상태 수정 가능 (새로 추가)

-- ============================================
-- 완료
-- ============================================


